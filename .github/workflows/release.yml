name: Release

on:
  push:
    tags:
      - 'v*.*.*'
  workflow_dispatch:
    inputs:
      version:
        description: 'ç‰ˆæœ¬å· (ä¾‹å¦‚: v1.0.0)'
        required: true
        default: 'v1.0.0'

env:
  XCODE_VERSION: '15.0'

jobs:
  build-and-release:
    name: æ„å»ºå¹¶å‘å¸ƒ
    runs-on: macos-latest
    permissions:
      contents: write  # å…è®¸åˆ›å»º Release å’Œä¸Šä¼ æ–‡ä»¶
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: è®¾ç½® Xcode ç‰ˆæœ¬
      uses: maxim-lobanov/setup-xcode@v1
      with:
        xcode-version: latest-stable
    
    - name: è·å–ç‰ˆæœ¬å·
      id: version
      run: |
        if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
          VERSION="${{ github.event.inputs.version }}"
        else
          VERSION="${GITHUB_REF#refs/tags/}"
        fi
        echo "VERSION=$VERSION" >> $GITHUB_ENV
        echo "version=$VERSION" >> $GITHUB_OUTPUT
        echo "ğŸ“¦ ç‰ˆæœ¬: $VERSION"
    
    - name: æ˜¾ç¤ºæ„å»ºä¿¡æ¯
      run: |
        echo "ğŸ—ï¸ MacAfk å‘å¸ƒæ„å»º"
        echo "ç‰ˆæœ¬: ${{ env.VERSION }}"
        echo "åˆ†æ”¯: ${{ github.ref }}"
        echo "æäº¤: ${{ github.sha }}"
        xcodebuild -version
    
    - name: æ„å»ºæ‰€æœ‰ç‰ˆæœ¬
      run: |
        chmod +x build.sh
        VERSION=${{ env.VERSION }} ./build.sh
    
    - name: éªŒè¯æ„å»ºäº§ç‰©
      run: |
        echo "ğŸ“¦ æ„å»ºäº§ç‰©ï¼š"
        ls -lh Dist/
        echo ""
        echo "ğŸ” æ ¡éªŒå’Œï¼š"
        cat Dist/checksums.txt
    
    - name: åˆ›å»º Release Notes
      id: release_notes
      run: |
        cat > release_notes.md << 'EOF'
        ## MacAfk Pro ${{ env.VERSION }}
        
        ### ğŸ“¦ ä¸‹è½½
        
        é€‰æ‹©é€‚åˆä½ çš„ç‰ˆæœ¬ï¼š
        
        - **é€šç”¨ç‰ˆæœ¬** (Apple Silicon + Intel): `MacAfk-Pro-Universal-${{ env.VERSION }}.dmg` â­ï¸ æ¨è
        - **Apple Silicon ä¸“ç”¨**: `MacAfk-Pro-arm64-${{ env.VERSION }}.dmg`
        - **Intel ä¸“ç”¨**: `MacAfk-Pro-x86_64-${{ env.VERSION }}.dmg`
        
        ### âœ¨ ç‰¹æ€§
        
        - âœ… çœŸå®ç¡¬ä»¶äº®åº¦æ§åˆ¶ï¼ˆDisplayServices APIï¼‰
        - âœ… æ›´å¥½çš„çœç”µæ•ˆæœ
        - âœ… é¼ æ ‡è‡ªåŠ¨æŠ–åŠ¨ï¼Œé˜²æ­¢ä¼‘çœ 
        - âœ… å¿«æ·é”®æ§åˆ¶ï¼ˆå¯è‡ªå®šä¹‰ï¼‰
        - âœ… å¤šè¯­è¨€æ”¯æŒï¼ˆä¸­æ–‡/è‹±æ–‡ï¼‰
        - âœ… èœå•æ å°å›¾æ ‡ï¼Œä¸å ç”¨ Dock
        - âœ… æŠ–åŠ¨é—´éš”è®¾ç½®æŒä¹…åŒ–
        - âœ… å¤šæ¶æ„æ”¯æŒï¼ˆApple Silicon + Intelï¼‰
        
        ### ğŸ”§ å®‰è£…è¯´æ˜
        
        1. ä¸‹è½½é€‚åˆä½ çš„ DMG æ–‡ä»¶
        2. æ‰“å¼€ DMGï¼Œå°†åº”ç”¨æ‹–åˆ°"åº”ç”¨ç¨‹åº"æ–‡ä»¶å¤¹
        3. é¦–æ¬¡è¿è¡Œæ—¶ï¼Œåœ¨ã€Œç³»ç»Ÿè®¾ç½® > éšç§ä¸å®‰å…¨æ€§ > è¾…åŠ©åŠŸèƒ½ã€ä¸­æˆäºˆæƒé™
        
        ### ğŸ” æ ¡éªŒå’Œ
        
        ä¸‹è½½åè¯·éªŒè¯æ–‡ä»¶å®Œæ•´æ€§ï¼š
        
        ```bash
        shasum -a 256 MacAfk-*.dmg
        ```
        
        è¯¦ç»†æ ¡éªŒå’Œè¯·å‚è§ `checksums.txt`
        
        ### ğŸ“ å®Œæ•´æ›´æ–°æ—¥å¿—
        
        è¯·æŸ¥çœ‹ [CHANGELOG.md](CHANGELOG.md) äº†è§£è¯¦ç»†æ›´æ”¹ã€‚
        
        ---
        
        **ç³»ç»Ÿè¦æ±‚**ï¼šmacOS 14.6 æˆ–æ›´é«˜ç‰ˆæœ¬
        
        **æ³¨æ„**ï¼šå¦‚æœéœ€è¦ App Store ç‰ˆæœ¬ï¼Œè¯·è®¿é—® [MacAfk Lite ä»“åº“](https://github.com/jiayuqi7813/macAFK-lite)
        EOF
        
        echo "release_notes<<EOF" >> $GITHUB_OUTPUT
        cat release_notes.md >> $GITHUB_OUTPUT
        echo "EOF" >> $GITHUB_OUTPUT
    
    - name: åˆ›å»º GitHub Release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: ${{ env.VERSION }}
        name: MacAfk ${{ env.VERSION }}
        body_path: release_notes.md
        draft: false
        prerelease: false
        files: |
          Dist/*.dmg
          Dist/checksums.txt
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    
    - name: ä¸Šä¼ æ„å»ºäº§ç‰©åˆ° Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: MacAfk-Release-${{ env.VERSION }}
        path: |
          Dist/*.dmg
          Dist/checksums.txt
        retention-days: 90
    
    - name: é€šçŸ¥æ„å»ºå®Œæˆ
      if: success()
      run: |
        echo "ğŸ‰ Release å‘å¸ƒæˆåŠŸï¼"
        echo "ç‰ˆæœ¬: ${{ env.VERSION }}"
        echo "æŸ¥çœ‹: https://github.com/${{ github.repository }}/releases/tag/${{ env.VERSION }}"
    
    - name: é€šçŸ¥æ„å»ºå¤±è´¥
      if: failure()
      run: |
        echo "âŒ Release å‘å¸ƒå¤±è´¥"
        echo "è¯·æ£€æŸ¥æ„å»ºæ—¥å¿—"

